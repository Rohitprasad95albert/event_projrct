<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Club Dashboard - EventSphere</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">EventSphere - Club Dashboard</a>
      <span class="text-white">Welcome, <span id="club-name">Club Member</span></span>
      <button class="btn btn-outline-light" onclick="logout()">Logout</button>
    </div>
  </nav>

  <div class="container mt-4">

    <h3>Create New Event</h3>
    <form id="event-form" class="mb-5">
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="title" class="form-label">Event Title</label>
          <input type="text" class="form-control" id="title" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="type" class="form-label">Event Type</label>
          <input type="text" class="form-control" id="type" placeholder="e.g., Tech, Cultural" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="venue" class="form-label">Venue</label>
          <input type="text" class="form-control" id="venue" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="date" class="form-label">Date</label>
          <input type="date" class="form-control" id="date" required>
        </div>
        <div class="col-md-6 mb-3">
            <label for="time" class="form-label">Time</label>
            <input type="time" class="form-control" id="time" required>
        </div>
        <div class="col-12 mb-3">
          <label for="description" class="form-label">Event Description</label>
          <textarea class="form-control" id="description" rows="4" required></textarea>
        </div>
         </div>
      <button type="submit" class="btn btn-success">Submit Proposal</button>
      <div class="text-success mt-2" id="proposal-msg" style="display: none;"></div>
      <div class="text-danger mt-2" id="proposal-error" style="display: none;"></div>
    </form>

    <h3>Your Submitted Events</h3>
    <table class="table table-striped table-bordered mt-3">
      <thead class="table-dark">
        <tr>
          <th>Title</th>
          <th>Date</th>
          <th>Venue</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="event-table">
        <tr><td colspan="4" class="text-center">Loading your events...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const userId = localStorage.getItem("userId"); // User ID from login
    const clubName = localStorage.getItem("name"); // Club name from login
    const userRole = localStorage.getItem("role"); // Role from login

    if (!userId || userRole !== 'club') {
      alert("⚠️ Please login as a club member to access this page.");
      window.location.href = "login.html";
    }
    document.getElementById("club-name").innerText = clubName;

    // Helper to get auth headers
    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }

    function logout() {
        localStorage.clear();
        window.location.href = "login.html";
    }

    // ✅ Submit Event Proposal
    document.getElementById("event-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const title = document.getElementById("title").value;
      const description = document.getElementById("description").value;
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const type = document.getElementById("type").value;
      const venue = document.getElementById("venue").value;
      // const posterFile = document.getElementById("poster").files[0]; // If using poster upload

      const proposalMsg = document.getElementById("proposal-msg");
      const proposalError = document.getElementById("proposal-error");
      proposalMsg.style.display = 'none';
      proposalError.style.display = 'none';

      try {
        // If you want to use poster upload, change to this:
        // const formData = new FormData();
        // formData.append('title', title);
        // formData.append('description', description);
        // formData.append('date', date);
        // formData.append('time', time);
        // formData.append('type', type);
        // formData.append('venue', venue);
        // if (posterFile) formData.append('poster', posterFile);

        // const res = await fetch("http://localhost:3000/api/events/create-with-poster", {
        //   method: "POST",
        //   headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }, // No Content-Type for FormData
        //   body: formData
        // });

        const res = await fetch("http://localhost:3000/api/events/create", {
          method: "POST",
          headers: getAuthHeaders(), // Include auth headers. Content-Type is already set by helper.
          body: JSON.stringify({ title, description, date, time, type, venue })
        });

        const result = await res.json();

        if (res.ok) {
          proposalMsg.innerText = `✅ "${title}" submitted for approval.`;
          proposalMsg.style.display = "block";
          document.getElementById("event-form").reset();
          loadClubEvents(); // refresh table
        } else {
          proposalError.innerText = "❌ " + (result.error || result.message || "Failed to submit event.");
          proposalError.style.display = "block";
        }
      } catch (err) {
        console.error("Error submitting event:", err);
        proposalError.innerText = "⚠️ Server error submitting event: " + err.message;
        proposalError.style.display = "block";
      }
    });

    // ✅ Load Events Created by This Club
    async function loadClubEvents() {
      try {
        const res = await fetch("http://localhost:3000/api/events", { headers: getAuthHeaders() });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const events = await res.json();

        const table = document.getElementById("event-table");
        table.innerHTML = ""; // Clear old rows

        // Filter events by the logged-in club's user ID (createdBy)
        const clubEvents = events.filter(e => e.createdBy && e.createdBy._id === userId);

        if (clubEvents.length === 0) {
            table.innerHTML = '<tr><td colspan="4" class="text-center">No events submitted yet.</td></tr>';
            return;
        }

        clubEvents.forEach(event => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${event.title}</td>
            <td>${event.date}</td>
            <td>${event.venue}</td>
            <td>${getStatusBadge(event.status)}</td>
          `;
          table.appendChild(row);
        });
      } catch (err) {
        console.error("Failed to load club events:", err);
        alert("❌ Failed to load club events. Please ensure you are logged in and authorized.");
        // Optionally redirect to login if token is invalid
        if (err.message.includes('401') || err.message.includes('403')) {
            logout();
        }
      }
    }

    function getStatusBadge(status) {
      if (status === "approved") return `<span class="badge bg-success">Approved</span>`;
      if (status === "pending") return `<span class="badge bg-warning text-dark">Pending</span>`;
      if (status === "rejected") return `<span class="badge bg-danger">Rejected</span>`;
      return status;
    }

    // ✅ On Load
    document.addEventListener("DOMContentLoaded", loadClubEvents);
  </script>
</body>
</html>