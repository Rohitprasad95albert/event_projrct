<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Certificate - EventSphere</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    #certificate-box {
      border: 5px solid #555;
      padding: 40px;
      width: 100%;
      max-width: 800px;
      margin: 40px auto;
      background-color: #fffdf6;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      text-align: center;
    }
    #certificate-box h1 {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    #certificate-box p {
      font-size: 18px;
      margin: 10px 0;
    }
    #download-btn {
      margin: 30px auto;
      display: block;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">EventSphere - Certificate</a>
      <a href="student-dashboard.html" class="btn btn-outline-light">Back to Dashboard</a>
    </div>
  </nav>

  <div id="certificate-box">
    <h1>Certificate of Participation</h1>
    <p>This is to certify that</p>
    <h2 id="student-name"><strong>Loading...</strong></h2>
    <p>has successfully participated in</p>
    <h3 id="event-name"><strong>Loading...</strong></h3>
    <p>held on <strong><span id="event-date">Date</span></strong> at <strong>ABC University</strong>.</p>
  </div>
  <button id="download-btn" class="btn btn-primary">Download Certificate</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const name = localStorage.getItem("name") || "Participant";
      const eventId = new URLSearchParams(window.location.search).get("id"); // Get 'id' parameter

      if (!eventId) {
        alert("⚠️ No event ID provided for certificate.");
        return;
      }

      document.getElementById("student-name").innerText = name;

      // Helper to get auth headers (needed if fetching event details directly)
      function getAuthHeaders() {
        const token = localStorage.getItem('token');
        return {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        };
      }

      try {
        // Fetch all events and find the specific one by ID
        const res = await fetch("https://event-projrct-1.onrender.com/api/events", { headers: getAuthHeaders() }); // Include auth
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const events = await res.json();
        const event = events.find(e => e._id === eventId);

        if (!event) return alert("❌ Event not found for certificate generation.");

        document.getElementById("event-name").innerText = event.title;
        document.getElementById("event-date").innerText = event.date;

      } catch (err) {
        console.error("Failed to load event details for certificate:", err);
        alert("❌ Failed to load event details for certificate.");
      }
    });

    // Download PDF
    document.getElementById("download-btn").addEventListener("click", () => {
      const element = document.getElementById("certificate-box");
      // Ensure correct scaling and quality for PDF generation
      html2pdf().from(element).set({
        margin: 10,
        filename: 'certificate.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).save();
    });
  </script>

</body>
</html>